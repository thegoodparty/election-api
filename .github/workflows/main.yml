name: Deploy

on:
  push:
    branches: ["develop", "qa", "master"]

env:
  AWS_REGION: us-west-2
  IMAGE_URI: 333022194791.dkr.ecr.us-west-2.amazonaws.com/election-api:${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::333022194791:role/github-actions-pulumi-deploy
          aws-region: us-west-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - run: npm ci

      - name: Build and push Docker image
        run: |
          docker build -t "${IMAGE_URI}" -f deploy/Dockerfile .
          docker push "${IMAGE_URI}"

      - name: Determine deployment context
        id: context
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "environment=preview" >> "$GITHUB_OUTPUT"
          else
            case "${{ github.ref_name }}" in
              develop) echo "environment=dev" >> "$GITHUB_OUTPUT" ;;
              qa) echo "environment=qa" >> "$GITHUB_OUTPUT" ;;
              master) echo "environment=prod" >> "$GITHUB_OUTPUT" ;;
            esac
          fi

      - name: Deploy
        working-directory: deploy
        run: ./deploy.sh ${{ steps.context.outputs.environment }}

      - name: Notify Slack on Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
          # only_mention_if: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
